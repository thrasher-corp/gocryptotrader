package charts

import (
	"io"
	"math/rand"
	"os"
	"reflect"
	"testing"
	"time"

	"github.com/thrasher-corp/gocryptotrader/currency"
	"github.com/thrasher-corp/gocryptotrader/exchanges/asset"
	"github.com/thrasher-corp/gocryptotrader/exchanges/kline"
)

func TestChartResult(t *testing.T) {
	ohlcvKline, _ := KlineItemToSeriesData(genOHCLVData(1))
	type fields struct {
		template     string
		TemplatePath string
		output       string
		outputPath   string
		Data         Data
		w            io.ReadWriter
		writeFile    bool
	}
	tests := []struct {
		name    string
		fields  fields
		want    []byte
		wantErr bool
	}{
		{
			"valid",
			fields{
				output:       "basic.html",
				outputPath:   "output",
				template:     "basic.tmpl",
				TemplatePath: "templates",
				writeFile:    false,
				Data: Data{
					Data: genIntervalData(1),
					size: size{
						Height: 1920,
						Width:  1080,
					},
				},
			},
			[]byte{10, 60, 33, 68, 79, 67, 84, 89, 80, 69, 32, 72, 84, 77, 76, 62, 10, 60, 104, 116, 109, 108, 32, 108, 97, 110, 103, 61, 39, 101, 110, 39, 62, 10, 32, 32, 32, 32, 60, 104, 101, 97, 100, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 60, 109, 101, 116, 97, 32, 99, 104, 97, 114, 115, 101, 116, 61, 39, 117, 116, 102, 45, 56, 39, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 60, 116, 105, 116, 108, 101, 62, 66, 97, 115, 105, 99, 32, 67, 104, 97, 114, 116, 32, 45, 32, 67, 104, 97, 114, 116, 115, 60, 47, 116, 105, 116, 108, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 115, 99, 114, 105, 112, 116, 32, 115, 114, 99, 61, 34, 104, 116, 116, 112, 115, 58, 47, 47, 117, 110, 112, 107, 103, 46, 99, 111, 109, 47, 108, 105, 103, 104, 116, 119, 101, 105, 103, 104, 116, 45, 99, 104, 97, 114, 116, 115, 64, 51, 46, 49, 46, 53, 47, 100, 105, 115, 116, 47, 108, 105, 103, 104, 116, 119, 101, 105, 103, 104, 116, 45, 99, 104, 97, 114, 116, 115, 46, 115, 116, 97, 110, 100, 97, 108, 111, 110, 101, 46, 112, 114, 111, 100, 117, 99, 116, 105, 111, 110, 46, 106, 115, 34, 62, 60, 47, 115, 99, 114, 105, 112, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 108, 105, 110, 107, 32, 114, 101, 108, 61, 34, 115, 116, 121, 108, 101, 115, 104, 101, 101, 116, 34, 32, 104, 114, 101, 102, 61, 34, 104, 116, 116, 112, 115, 58, 47, 47, 115, 116, 97, 99, 107, 112, 97, 116, 104, 46, 98, 111, 111, 116, 115, 116, 114, 97, 112, 99, 100, 110, 46, 99, 111, 109, 47, 98, 111, 111, 116, 115, 116, 114, 97, 112, 47, 53, 46, 48, 46, 48, 45, 97, 108, 112, 104, 97, 49, 47, 99, 115, 115, 47, 98, 111, 111, 116, 115, 116, 114, 97, 112, 46, 109, 105, 110, 46, 99, 115, 115, 34, 32, 105, 110, 116, 101, 103, 114, 105, 116, 121, 61, 34, 115, 104, 97, 51, 56, 52, 45, 114, 52, 78, 121, 80, 52, 54, 75, 114, 106, 68, 108, 101, 97, 119, 66, 103, 68, 53, 116, 112, 56, 89, 55, 85, 122, 109, 76, 65, 48, 53, 111, 77, 49, 105, 65, 69, 81, 49, 55, 67, 83, 117, 68, 113, 110, 85, 75, 50, 43, 107, 57, 108, 117, 88, 81, 79, 102, 88, 74, 67, 74, 52, 73, 34, 32, 99, 114, 111, 115, 115, 111, 114, 105, 103, 105, 110, 61, 34, 97, 110, 111, 110, 121, 109, 111, 117, 115, 34, 62, 10, 32, 32, 32, 32, 60, 47, 104, 101, 97, 100, 62, 10, 32, 32, 32, 32, 60, 98, 111, 100, 121, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 60, 115, 99, 114, 105, 112, 116, 62, 32, 108, 101, 116, 32, 99, 104, 97, 114, 116, 32, 61, 32, 76, 105, 103, 104, 116, 119, 101, 105, 103, 104, 116, 67, 104, 97, 114, 116, 115, 46, 99, 114, 101, 97, 116, 101, 67, 104, 97, 114, 116, 40, 100, 111, 99, 117, 109, 101, 110, 116, 46, 98, 111, 100, 121, 44, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 119, 105, 100, 116, 104, 58, 32, 32, 49, 48, 56, 48, 32, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 104, 101, 105, 103, 104, 116, 58, 32, 32, 49, 57, 50, 48, 32, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 114, 105, 103, 104, 116, 80, 114, 105, 99, 101, 83, 99, 97, 108, 101, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 115, 99, 97, 108, 101, 77, 97, 114, 103, 105, 110, 115, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 9, 116, 111, 112, 58, 32, 48, 46, 49, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 9, 98, 111, 116, 116, 111, 109, 58, 32, 48, 46, 50, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 119, 97, 116, 101, 114, 109, 97, 114, 107, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 118, 105, 115, 105, 98, 108, 101, 58, 32, 116, 114, 117, 101, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 102, 111, 110, 116, 83, 105, 122, 101, 58, 32, 50, 52, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 104, 111, 114, 122, 65, 108, 105, 103, 110, 58, 32, 39, 99, 101, 110, 116, 101, 114, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 118, 101, 114, 116, 65, 108, 105, 103, 110, 58, 32, 39, 99, 101, 110, 116, 101, 114, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 99, 111, 108, 111, 114, 58, 32, 39, 114, 103, 98, 97, 40, 49, 55, 49, 44, 32, 55, 49, 44, 32, 49, 56, 56, 44, 32, 48, 46, 53, 41, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 116, 101, 120, 116, 58, 32, 39, 71, 111, 67, 114, 121, 112, 116, 111, 84, 114, 97, 100, 101, 114, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 108, 97, 121, 111, 117, 116, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 98, 97, 99, 107, 103, 114, 111, 117, 110, 100, 67, 111, 108, 111, 114, 58, 32, 39, 35, 102, 102, 102, 102, 102, 102, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 116, 101, 120, 116, 67, 111, 108, 111, 114, 58, 32, 39, 35, 51, 51, 51, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 103, 114, 105, 100, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 104, 111, 114, 122, 76, 105, 110, 101, 115, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 9, 99, 111, 108, 111, 114, 58, 32, 39, 35, 101, 101, 101, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 118, 101, 114, 116, 76, 105, 110, 101, 115, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 9, 99, 111, 108, 111, 114, 58, 32, 39, 35, 102, 102, 102, 102, 102, 102, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 125, 41, 59, 10, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 108, 101, 116, 32, 97, 114, 101, 97, 83, 101, 114, 105, 101, 115, 32, 61, 32, 99, 104, 97, 114, 116, 46, 97, 100, 100, 65, 114, 101, 97, 83, 101, 114, 105, 101, 115, 40, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 116, 111, 112, 67, 111, 108, 111, 114, 58, 32, 39, 114, 103, 98, 97, 40, 49, 55, 49, 44, 32, 55, 49, 44, 32, 49, 56, 56, 44, 32, 48, 46, 53, 54, 41, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 98, 111, 116, 116, 111, 109, 67, 111, 108, 111, 114, 58, 32, 39, 114, 103, 98, 97, 40, 49, 55, 49, 44, 32, 55, 49, 44, 32, 49, 56, 56, 44, 32, 48, 46, 48, 52, 41, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 108, 105, 110, 101, 67, 111, 108, 111, 114, 58, 32, 39, 114, 103, 98, 97, 40, 49, 55, 49, 44, 32, 55, 49, 44, 32, 49, 56, 56, 44, 32, 49, 41, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 108, 105, 110, 101, 87, 105, 100, 116, 104, 58, 32, 50, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 115, 121, 109, 98, 111, 108, 58, 32, 39, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 125, 41, 59, 10, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 97, 114, 101, 97, 83, 101, 114, 105, 101, 115, 46, 115, 101, 116, 68, 97, 116, 97, 40, 91, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 123, 32, 116, 105, 109, 101, 58, 32, 39, 50, 48, 49, 57, 45, 48, 49, 45, 48, 49, 39, 44, 32, 118, 97, 108, 117, 101, 58, 32, 32, 48, 32, 32, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 93, 41, 59, 10, 32, 32, 32, 32, 32, 32, 32, 60, 47, 115, 99, 114, 105, 112, 116, 62, 10, 10, 32, 32, 32, 32, 32, 32, 32, 32, 60, 115, 99, 114, 105, 112, 116, 32, 115, 114, 99, 61, 34, 104, 116, 116, 112, 115, 58, 47, 47, 99, 100, 110, 46, 106, 115, 100, 101, 108, 105, 118, 114, 46, 110, 101, 116, 47, 110, 112, 109, 47, 112, 111, 112, 112, 101, 114, 46, 106, 115, 64, 49, 46, 49, 54, 46, 48, 47, 100, 105, 115, 116, 47, 117, 109, 100, 47, 112, 111, 112, 112, 101, 114, 46, 109, 105, 110, 46, 106, 115, 34, 32, 105, 110, 116, 101, 103, 114, 105, 116, 121, 61, 34, 115, 104, 97, 51, 56, 52, 45, 81, 54, 69, 57, 82, 72, 118, 98, 73, 121, 90, 70, 74, 111, 102, 116, 43, 50, 109, 74, 98, 72, 97, 69, 87, 108, 100, 108, 118, 73, 57, 73, 79, 89, 121, 53, 110, 51, 122, 86, 57, 122, 122, 84, 116, 109, 73, 51, 85, 107, 115, 100, 81, 82, 86, 118, 111, 120, 77, 102, 111, 111, 65, 111, 34, 32, 99, 114, 111, 115, 115, 111, 114, 105, 103, 105, 110, 61, 34, 97, 110, 111, 110, 121, 109, 111, 117, 115, 34, 62, 60, 47, 115, 99, 114, 105, 112, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 60, 115, 99, 114, 105, 112, 116, 32, 115, 114, 99, 61, 34, 104, 116, 116, 112, 115, 58, 47, 47, 115, 116, 97, 99, 107, 112, 97, 116, 104, 46, 98, 111, 111, 116, 115, 116, 114, 97, 112, 99, 100, 110, 46, 99, 111, 109, 47, 98, 111, 111, 116, 115, 116, 114, 97, 112, 47, 53, 46, 48, 46, 48, 45, 97, 108, 112, 104, 97, 49, 47, 106, 115, 47, 98, 111, 111, 116, 115, 116, 114, 97, 112, 46, 109, 105, 110, 46, 106, 115, 34, 32, 105, 110, 116, 101, 103, 114, 105, 116, 121, 61, 34, 115, 104, 97, 51, 56, 52, 45, 111, 101, 115, 105, 54, 50, 104, 79, 76, 102, 122, 114, 121, 115, 52, 76, 120, 82, 70, 54, 51, 79, 74, 67, 88, 100, 88, 68, 105, 112, 105, 89, 87, 66, 110, 118, 84, 108, 57, 89, 57, 47, 84, 82, 108, 119, 53, 120, 108, 75, 73, 69, 72, 112, 78, 121, 118, 118, 68, 83, 104, 103, 102, 47, 34, 32, 99, 114, 111, 115, 115, 111, 114, 105, 103, 105, 110, 61, 34, 97, 110, 111, 110, 121, 109, 111, 117, 115, 34, 62, 60, 47, 115, 99, 114, 105, 112, 116, 62, 10, 32, 32, 32, 32, 60, 47, 98, 111, 100, 121, 62, 10, 60, 47, 104, 116, 109, 108, 62, 10, 10, 10, 10},
			false,
		},
		{
			"valid-timeseries",
			fields{
				output:       "timeseries.html",
				outputPath:   "output",
				template:     "timeseries.tmpl",
				TemplatePath: "",
				writeFile:    false,
				Data: Data{
					Data: ohlcvKline,
					size: size{
						Height: 1920,
						Width:  1080,
					},
				},
			},
			[]byte{10, 60, 33, 68, 79, 67, 84, 89, 80, 69, 32, 72, 84, 77, 76, 62, 10, 60, 104, 116, 109, 108, 32, 108, 97, 110, 103, 61, 39, 101, 110, 39, 62, 10, 32, 32, 32, 32, 60, 104, 101, 97, 100, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 60, 109, 101, 116, 97, 32, 99, 104, 97, 114, 115, 101, 116, 61, 39, 117, 116, 102, 45, 56, 39, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 60, 116, 105, 116, 108, 101, 62, 66, 97, 115, 105, 99, 32, 67, 104, 97, 114, 116, 32, 45, 32, 67, 104, 97, 114, 116, 115, 60, 47, 116, 105, 116, 108, 101, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 115, 99, 114, 105, 112, 116, 32, 115, 114, 99, 61, 34, 104, 116, 116, 112, 115, 58, 47, 47, 117, 110, 112, 107, 103, 46, 99, 111, 109, 47, 108, 105, 103, 104, 116, 119, 101, 105, 103, 104, 116, 45, 99, 104, 97, 114, 116, 115, 64, 51, 46, 49, 46, 53, 47, 100, 105, 115, 116, 47, 108, 105, 103, 104, 116, 119, 101, 105, 103, 104, 116, 45, 99, 104, 97, 114, 116, 115, 46, 115, 116, 97, 110, 100, 97, 108, 111, 110, 101, 46, 112, 114, 111, 100, 117, 99, 116, 105, 111, 110, 46, 106, 115, 34, 62, 60, 47, 115, 99, 114, 105, 112, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 60, 108, 105, 110, 107, 32, 114, 101, 108, 61, 34, 115, 116, 121, 108, 101, 115, 104, 101, 101, 116, 34, 32, 104, 114, 101, 102, 61, 34, 104, 116, 116, 112, 115, 58, 47, 47, 115, 116, 97, 99, 107, 112, 97, 116, 104, 46, 98, 111, 111, 116, 115, 116, 114, 97, 112, 99, 100, 110, 46, 99, 111, 109, 47, 98, 111, 111, 116, 115, 116, 114, 97, 112, 47, 53, 46, 48, 46, 48, 45, 97, 108, 112, 104, 97, 49, 47, 99, 115, 115, 47, 98, 111, 111, 116, 115, 116, 114, 97, 112, 46, 109, 105, 110, 46, 99, 115, 115, 34, 32, 105, 110, 116, 101, 103, 114, 105, 116, 121, 61, 34, 115, 104, 97, 51, 56, 52, 45, 114, 52, 78, 121, 80, 52, 54, 75, 114, 106, 68, 108, 101, 97, 119, 66, 103, 68, 53, 116, 112, 56, 89, 55, 85, 122, 109, 76, 65, 48, 53, 111, 77, 49, 105, 65, 69, 81, 49, 55, 67, 83, 117, 68, 113, 110, 85, 75, 50, 43, 107, 57, 108, 117, 88, 81, 79, 102, 88, 74, 67, 74, 52, 73, 34, 32, 99, 114, 111, 115, 115, 111, 114, 105, 103, 105, 110, 61, 34, 97, 110, 111, 110, 121, 109, 111, 117, 115, 34, 62, 10, 32, 32, 32, 32, 60, 47, 104, 101, 97, 100, 62, 10, 32, 32, 32, 32, 60, 98, 111, 100, 121, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 60, 115, 99, 114, 105, 112, 116, 62, 32, 108, 101, 116, 32, 99, 104, 97, 114, 116, 32, 61, 32, 76, 105, 103, 104, 116, 119, 101, 105, 103, 104, 116, 67, 104, 97, 114, 116, 115, 46, 99, 114, 101, 97, 116, 101, 67, 104, 97, 114, 116, 40, 100, 111, 99, 117, 109, 101, 110, 116, 46, 98, 111, 100, 121, 44, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 119, 105, 100, 116, 104, 58, 32, 32, 49, 48, 56, 48, 32, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 104, 101, 105, 103, 104, 116, 58, 32, 32, 49, 57, 50, 48, 32, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 114, 105, 103, 104, 116, 80, 114, 105, 99, 101, 83, 99, 97, 108, 101, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 115, 99, 97, 108, 101, 77, 97, 114, 103, 105, 110, 115, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 9, 116, 111, 112, 58, 32, 48, 46, 49, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 9, 98, 111, 116, 116, 111, 109, 58, 32, 48, 46, 50, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 119, 97, 116, 101, 114, 109, 97, 114, 107, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 118, 105, 115, 105, 98, 108, 101, 58, 32, 116, 114, 117, 101, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 102, 111, 110, 116, 83, 105, 122, 101, 58, 32, 50, 52, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 104, 111, 114, 122, 65, 108, 105, 103, 110, 58, 32, 39, 99, 101, 110, 116, 101, 114, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 118, 101, 114, 116, 65, 108, 105, 103, 110, 58, 32, 39, 99, 101, 110, 116, 101, 114, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 99, 111, 108, 111, 114, 58, 32, 39, 114, 103, 98, 97, 40, 49, 55, 49, 44, 32, 55, 49, 44, 32, 49, 56, 56, 44, 32, 48, 46, 53, 41, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 116, 101, 120, 116, 58, 32, 39, 71, 111, 67, 114, 121, 112, 116, 111, 84, 114, 97, 100, 101, 114, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 108, 97, 121, 111, 117, 116, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 98, 97, 99, 107, 103, 114, 111, 117, 110, 100, 67, 111, 108, 111, 114, 58, 32, 39, 35, 102, 102, 102, 102, 102, 102, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 116, 101, 120, 116, 67, 111, 108, 111, 114, 58, 32, 39, 35, 51, 51, 51, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 103, 114, 105, 100, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 104, 111, 114, 122, 76, 105, 110, 101, 115, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 9, 99, 111, 108, 111, 114, 58, 32, 39, 35, 101, 101, 101, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 118, 101, 114, 116, 76, 105, 110, 101, 115, 58, 32, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 9, 99, 111, 108, 111, 114, 58, 32, 39, 35, 102, 102, 102, 102, 102, 102, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 125, 41, 59, 10, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 108, 101, 116, 32, 97, 114, 101, 97, 83, 101, 114, 105, 101, 115, 32, 61, 32, 99, 104, 97, 114, 116, 46, 97, 100, 100, 65, 114, 101, 97, 83, 101, 114, 105, 101, 115, 40, 123, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 116, 111, 112, 67, 111, 108, 111, 114, 58, 32, 39, 114, 103, 98, 97, 40, 49, 55, 49, 44, 32, 55, 49, 44, 32, 49, 56, 56, 44, 32, 48, 46, 53, 54, 41, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 98, 111, 116, 116, 111, 109, 67, 111, 108, 111, 114, 58, 32, 39, 114, 103, 98, 97, 40, 49, 55, 49, 44, 32, 55, 49, 44, 32, 49, 56, 56, 44, 32, 48, 46, 48, 52, 41, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 108, 105, 110, 101, 67, 111, 108, 111, 114, 58, 32, 39, 114, 103, 98, 97, 40, 49, 55, 49, 44, 32, 55, 49, 44, 32, 49, 56, 56, 44, 32, 49, 41, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 108, 105, 110, 101, 87, 105, 100, 116, 104, 58, 32, 50, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 9, 115, 121, 109, 98, 111, 108, 58, 32, 39, 39, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 125, 41, 59, 10, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 97, 114, 101, 97, 83, 101, 114, 105, 101, 115, 46, 115, 101, 116, 68, 97, 116, 97, 40, 91, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 123, 32, 116, 105, 109, 101, 58, 32, 39, 50, 48, 49, 57, 45, 48, 49, 45, 48, 49, 39, 44, 32, 118, 97, 108, 117, 101, 58, 32, 32, 48, 32, 32, 125, 44, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 93, 41, 59, 10, 32, 32, 32, 32, 32, 32, 32, 60, 47, 115, 99, 114, 105, 112, 116, 62, 10, 10, 32, 32, 32, 32, 32, 32, 32, 32, 60, 115, 99, 114, 105, 112, 116, 32, 115, 114, 99, 61, 34, 104, 116, 116, 112, 115, 58, 47, 47, 99, 100, 110, 46, 106, 115, 100, 101, 108, 105, 118, 114, 46, 110, 101, 116, 47, 110, 112, 109, 47, 112, 111, 112, 112, 101, 114, 46, 106, 115, 64, 49, 46, 49, 54, 46, 48, 47, 100, 105, 115, 116, 47, 117, 109, 100, 47, 112, 111, 112, 112, 101, 114, 46, 109, 105, 110, 46, 106, 115, 34, 32, 105, 110, 116, 101, 103, 114, 105, 116, 121, 61, 34, 115, 104, 97, 51, 56, 52, 45, 81, 54, 69, 57, 82, 72, 118, 98, 73, 121, 90, 70, 74, 111, 102, 116, 43, 50, 109, 74, 98, 72, 97, 69, 87, 108, 100, 108, 118, 73, 57, 73, 79, 89, 121, 53, 110, 51, 122, 86, 57, 122, 122, 84, 116, 109, 73, 51, 85, 107, 115, 100, 81, 82, 86, 118, 111, 120, 77, 102, 111, 111, 65, 111, 34, 32, 99, 114, 111, 115, 115, 111, 114, 105, 103, 105, 110, 61, 34, 97, 110, 111, 110, 121, 109, 111, 117, 115, 34, 62, 60, 47, 115, 99, 114, 105, 112, 116, 62, 10, 32, 32, 32, 32, 32, 32, 32, 32, 60, 115, 99, 114, 105, 112, 116, 32, 115, 114, 99, 61, 34, 104, 116, 116, 112, 115, 58, 47, 47, 115, 116, 97, 99, 107, 112, 97, 116, 104, 46, 98, 111, 111, 116, 115, 116, 114, 97, 112, 99, 100, 110, 46, 99, 111, 109, 47, 98, 111, 111, 116, 115, 116, 114, 97, 112, 47, 53, 46, 48, 46, 48, 45, 97, 108, 112, 104, 97, 49, 47, 106, 115, 47, 98, 111, 111, 116, 115, 116, 114, 97, 112, 46, 109, 105, 110, 46, 106, 115, 34, 32, 105, 110, 116, 101, 103, 114, 105, 116, 121, 61, 34, 115, 104, 97, 51, 56, 52, 45, 111, 101, 115, 105, 54, 50, 104, 79, 76, 102, 122, 114, 121, 115, 52, 76, 120, 82, 70, 54, 51, 79, 74, 67, 88, 100, 88, 68, 105, 112, 105, 89, 87, 66, 110, 118, 84, 108, 57, 89, 57, 47, 84, 82, 108, 119, 53, 120, 108, 75, 73, 69, 72, 112, 78, 121, 118, 118, 68, 83, 104, 103, 102, 47, 34, 32, 99, 114, 111, 115, 115, 111, 114, 105, 103, 105, 110, 61, 34, 97, 110, 111, 110, 121, 109, 111, 117, 115, 34, 62, 60, 47, 115, 99, 114, 105, 112, 116, 62, 10, 32, 32, 32, 32, 60, 47, 98, 111, 100, 121, 62, 10, 60, 47, 104, 116, 109, 108, 62, 10, 10, 10, 10},
			false,
		},
	}
	for x := range tests {
		tt := tests[x]
		t.Run(tt.name, func(t *testing.T) {
			c := &Chart{
				template:     tt.fields.template,
				TemplatePath: tt.fields.TemplatePath,
				output:       tt.fields.output,
				OutputPath:   tt.fields.outputPath,
				Data:         tt.fields.Data,
				w:            tt.fields.w,
				WriteFile:    tt.fields.writeFile,
			}
			f, err := c.Generate()
			if err != nil {
				t.Fatal(err)
			}
			got, err := c.Result()
			if (err != nil) != tt.wantErr {
				t.Errorf("Result() error = %v, wantErr %v", err, tt.wantErr)
				return
			}
			if !reflect.DeepEqual(got, tt.want) {
				t.Errorf("Result() got = %v, want %v", got, tt.want)
			}
			if f != nil {
				err = f.Close()
				if err != nil {
					t.Error("failed to close file manual removal may be required")
				}
				err = os.Remove(f.Name())
				if err != nil {
					t.Error("failed to remove file manual removal may be required")
				}
			}
		})
	}
}

func TestNew(t *testing.T) {
	tests := []struct {
		name string
		want Chart
	}{
		{
			"basic",
			Chart{
				output:   "basic",
				template: "basic.tmpl",
			},
		},
		{
			"timeseries",
			Chart{
				output:   "timeseries",
				template: "timeseries.tmpl",
			},
		},
	}
	for x := range tests {
		tt := tests[x]
		t.Run(tt.name, func(t *testing.T) {
			if got := New(tt.name, tt.name, ""); !reflect.DeepEqual(got, tt.want) {
				t.Errorf("New() = %v, want %v", got, tt.want)
			}
		})
	}
}

func genIntervalData(totalCandles int) []IntervalData {
	start := time.Date(2019, 1, 1, 0, 0, 0, 0, time.UTC)
	out := make([]IntervalData, totalCandles)
	out[0] = IntervalData{Timestamp: start.Format("2006-01-02"), Value: 0}
	for x := 1; x < totalCandles; x++ {
		out[x] = IntervalData{
			Timestamp: start.Add(time.Hour * 24 * time.Duration(x)).Format("2006-01-02"),
			Value:     out[x-1].Value + rand.Float64(),
		}
	}

	return out
}

func genOHCLVData(totalCandles int) *kline.Item {
	start := time.Date(2019, 1, 1, 0, 0, 0, 0, time.UTC)

	var outItem kline.Item
	outItem.Interval = kline.OneDay
	outItem.Asset = asset.Spot
	outItem.Pair = currency.NewPair(currency.BTC, currency.USDT)
	outItem.Exchange = "test"

	outItem.Candles = make([]kline.Candle, 365)
	outItem.Candles[0] = kline.Candle{
		Time:   start,
		Open:   0,
		High:   10 + rand.Float64(),
		Low:    10 + rand.Float64(),
		Close:  10 + rand.Float64(),
		Volume: 10,
	}

	for x := 1; x < totalCandles; x++ {
		outItem.Candles[x] = kline.Candle{
			Time:   start.Add(time.Hour * 24 * time.Duration(x)),
			Open:   outItem.Candles[x-1].Close,
			High:   outItem.Candles[x-1].Open + rand.Float64(),
			Low:    outItem.Candles[x-1].Open - rand.Float64(),
			Close:  outItem.Candles[x-1].Open + rand.Float64(),
			Volume: float64(rand.Int63n(150)),
		}
	}

	return &outItem
}

func TestChartGenerate(t *testing.T) {
	ohlcvKline, _ := KlineItemToSeriesData(genOHCLVData(365))
	type fields struct {
		template     string
		TemplatePath string
		output       string
		OutputPath   string
		Data         Data
		w            io.ReadWriter
		WriteFile    bool
	}
	tests := []struct {
		name    string
		fields  fields
		wantOut *os.File
		wantErr bool
	}{
		{
			"basic",
			fields{
				output:     "basic.html",
				OutputPath: "output",
				template:   "basic.tmpl",
				WriteFile:  true,
				Data: Data{
					Data: genIntervalData(365),
				},
			},
			&os.File{},
			false,
		},
		{
			"timeseries",
			fields{
				output:       "timeseries.html",
				OutputPath:   "output",
				template:     "timeseries.tmpl",
				TemplatePath: "templates",
				WriteFile:    true,
				Data: Data{
					Data: ohlcvKline,
				},
			},
			nil,
			false,
		},
	}
	for x := range tests {
		tt := tests[x]
		t.Run(tt.name, func(t *testing.T) {
			c := &Chart{
				template:     tt.fields.template,
				TemplatePath: tt.fields.TemplatePath,
				output:       tt.fields.output,
				OutputPath:   tt.fields.OutputPath,
				Data:         tt.fields.Data,
				w:            tt.fields.w,
				WriteFile:    tt.fields.WriteFile,
			}
			f, err := c.Generate()
			if (err != nil) != tt.wantErr {
				t.Errorf("Generate() error = %v, wantErr %v", err, tt.wantErr)
				return
			}
			if f != nil {
				_ = f.Close()
				_ = os.Remove(f.Name())
			}
		})
	}
}
